# 后台管理系统需求文档

> 版本: 1.0
> 日期: 2026-03-01
> 项目: AI 客服聊天系统 (Next.js 16 + LangChain)

---

## 目录

1. [功能概述](#1-功能概述)
2. [现有实现盘点](#2-现有实现盘点)
3. [页面结构设计](#3-页面结构设计)
4. [子页面功能详述](#4-子页面功能详述)
5. [API 接口设计](#5-api-接口设计)
6. [路由保护](#6-路由保护)
7. [交互细节](#7-交互细节)
8. [涉及文件清单](#8-涉及文件清单)
9. [验收标准](#9-验收标准)

---

## 1. 功能概述

### 1.1 目标

为 admin 角色用户提供一个后台管理入口，可在后台页面中统一管理项目核心数据，包括：

- **用户管理**：查看所有用户列表、搜索用户、修改用户角色
- **知识库文档管理**：查看所有用户上传的知识库文档、查看文档状态

### 1.2 核心能力

- 聊天页面顶部导航栏新增"后台管理"入口（仅 admin 可见），点击跳转到 `/admin`
- 后台管理页面采用左侧导航 + 右侧内容区布局
- 用户管理：展示所有用户列表，支持按用户名/邮箱搜索，支持修改用户角色（user/admin）
- 知识库文档管理：展示所有用户上传的文档列表，显示文档状态、归属用户等信息
- 仅 admin 角色可访问 `/admin` 及其子路由，非 admin 访问时重定向到 `/chat`

### 1.3 用户场景

1. admin 用户登录后，在聊天页面顶部导航栏可见"后台管理"链接
2. 点击进入 `/admin` 后台管理页面，默认显示用户管理子页面
3. 通过左侧导航在"用户管理"和"知识库文档"之间切换
4. 在用户管理页面可搜索用户、查看用户信息、修改角色
5. 在知识库文档页面可查看所有文档的状态和归属

---

## 2. 现有实现盘点

### 2.1 已有的相关实现

| 模块 | 文件 | 说明 |
|------|------|------|
| admin 入口按钮 | `app/chat/page.tsx` 第 289-296 行 | 聊天页面顶部导航栏已有 admin 角色判断，当前链接指向 `/kb`（知识库入口） |
| 用户角色字段 | `lib/db.ts` 第 57 行 | users 表已有 `role` 列（VARCHAR(20)，默认值 `'user'`） |
| JWT 含角色 | `lib/auth.ts` 第 11-15 行 | JwtPayload 已包含 `role` 字段 |
| AuthContext 含角色 | `app/contexts/AuthContext.tsx` 第 10 行 | User 接口已包含 `role` 字段 |
| 知识库文档表 | `lib/db.ts` 第 67-78 行 | `kb_documents` 表已有完整结构（id, user_id, filename, file_size, chunk_count, status, created_at） |
| 知识库 API | `app/api/kb/route.ts` | 现有 GET 接口按当前用户过滤文档，后台管理需要新建 API 查看全部文档 |
| 知识库管理页面 | `app/kb/page.tsx` | 现有知识库管理页面（含上传、删除功能），后台文档管理页面仅需查看，无需上传/删除 |

### 2.2 需要新增的部分

- 聊天页面顶部导航栏新增"后台管理"链接（保留现有"知识库"链接）
- `/admin` 后台管理布局页面（左侧导航 + 内容区）
- `/admin` 用户管理子页面
- `/admin/documents` 知识库文档管理子页面
- 后台管理 API（用户列表、用户搜索、角色修改、全量文档列表）

---

## 3. 页面结构设计

### 3.1 整体布局

后台管理页面采用经典的管理后台布局：

```
┌─────────────────────────────────────────────────────────┐
│  顶部导航栏（标题 + 返回聊天 + 用户名 + 退出）           │
├──────────┬──────────────────────────────────────────────┤
│          │                                              │
│  左侧    │                                              │
│  导航栏  │          内容区域                              │
│          │                                              │
│  · 用户  │   （根据当前选中的导航项展示对应子页面）        │
│    管理  │                                              │
│          │                                              │
│  · 知识库│                                              │
│    文档  │                                              │
│          │                                              │
├──────────┴──────────────────────────────────────────────┤
```

### 3.2 顶部导航栏

- 左侧：后台管理标题
- 右侧：「返回聊天」链接 + 用户名 + 「退出」按钮
- 样式与聊天页面顶部导航栏保持一致（使用 `--header-bg`、`backdrop-blur` 等）

### 3.3 左侧导航栏

- 固定宽度 `w-56`（224px）
- 导航项：
  - 用户管理（图标 + 文字）：对应路由 `/admin`
  - 知识库文档（图标 + 文字）：对应路由 `/admin/documents`
- 当前激活项高亮（使用 `bg-accent/10 text-accent` 样式）
- 移动端：左侧导航栏默认隐藏，通过汉堡菜单展开（与聊天页面侧边栏行为一致）

### 3.4 路由结构

| 路由 | 页面 | 说明 |
|------|------|------|
| `/admin` | 用户管理 | 后台首页，默认展示用户管理 |
| `/admin/documents` | 知识库文档管理 | 查看所有用户的知识库文档 |

---

## 4. 子页面功能详述

### 4.1 用户管理页面（`/admin`）

#### 4.1.1 搜索区域

- 搜索输入框：支持按用户名或邮箱搜索（模糊匹配）
- 搜索为即时过滤（输入后延迟 300ms 自动搜索，无需点击按钮）
- 搜索框使用项目统一的 `input-glow` 样式

#### 4.1.2 用户列表

以表格形式展示所有用户，列包括：

| 列名 | 字段 | 说明 |
|------|------|------|
| 用户名 | username | 用户名称 |
| 邮箱 | email | 用户邮箱 |
| 角色 | role | 当前角色，可点击切换 |
| 注册时间 | created_at | 格式化为 `zh-CN` 本地时间 |

#### 4.1.3 角色管理

- 角色列显示为下拉选择器（`<select>`），选项为 `user` 和 `admin`
- 切换角色后立即调用 API 更新，成功后刷新列表
- admin 不能修改自己的角色（防止意外降级，下拉选择器置灰）
- 角色标签样式：
  - `admin`：紫色标签（`bg-accent/10 text-accent`）
  - `user`：灰色标签（`bg-gray-100 text-gray-600`）

#### 4.1.4 统计信息

- 页面顶部显示统计卡片：总用户数、管理员数量
- 卡片使用 `bg-surface border border-edge rounded-xl` 样式

### 4.2 知识库文档管理页面（`/admin/documents`）

#### 4.2.1 文档列表

以表格形式展示所有用户的知识库文档，列包括：

| 列名 | 字段 | 说明 |
|------|------|------|
| 文件名 | filename | 文档文件名 |
| 上传者 | username | 文档归属用户的用户名 |
| 文件大小 | file_size | 格式化显示（B/KB/MB） |
| 分块数 | chunk_count | 向量分块数量 |
| 状态 | status | processing/ready/error，用彩色标签显示 |
| 上传时间 | created_at | 格式化为 `zh-CN` 本地时间 |

#### 4.2.2 状态标签样式

复用现有知识库页面的状态样式：

- `ready`（就绪）：绿色标签
- `processing`（处理中）：黄色标签
- `error`（错误）：红色标签

#### 4.2.3 统计信息

- 页面顶部显示统计卡片：总文档数、就绪文档数、处理中文档数

---

## 5. API 接口设计

所有后台管理 API 均需要认证（JWT）且仅限 admin 角色访问。

### 5.1 获取用户列表

```
GET /api/admin/users?search=keyword
```

**请求参数**：

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| search | string | 否 | 搜索关键词（匹配用户名或邮箱） |

**响应**：

```json
{
  "success": true,
  "users": [
    {
      "id": "uuid",
      "username": "string",
      "email": "string",
      "role": "user|admin",
      "createdAt": "ISO8601"
    }
  ],
  "total": 10
}
```

**权限**：仅 admin

### 5.2 修改用户角色

```
PATCH /api/admin/users/[userId]
```

**请求体**：

```json
{
  "role": "user|admin"
}
```

**响应**：

```json
{
  "success": true,
  "user": {
    "id": "uuid",
    "username": "string",
    "role": "user|admin"
  }
}
```

**权限**：仅 admin，且不能修改自身角色

**错误码**：

| HTTP 状态码 | 错误信息 | 场景 |
|-------------|----------|------|
| 401 | 未登录 | 无有效 JWT |
| 403 | 无权访问 | 非 admin 角色 |
| 400 | 不能修改自己的角色 | 尝试修改自身角色 |
| 400 | 无效的角色值 | role 不是 user 或 admin |
| 404 | 用户不存在 | userId 无效 |

### 5.3 获取所有知识库文档

```
GET /api/admin/documents
```

**响应**：

```json
{
  "success": true,
  "documents": [
    {
      "id": "uuid",
      "filename": "string",
      "fileSize": 1024,
      "chunkCount": 5,
      "status": "ready",
      "createdAt": "ISO8601",
      "userId": "uuid",
      "username": "string"
    }
  ],
  "total": 20
}
```

**权限**：仅 admin

**SQL 说明**：需要 JOIN `users` 表以获取 `username` 字段

---

## 6. 路由保护

### 6.1 服务端保护（API 层）

所有 `/api/admin/*` 接口在处理函数开头执行以下检查：

1. 调用 `getUserFromRequest()` 获取用户身份
2. 若返回 `null`，返回 401 错误
3. 若 `payload.role !== 'admin'`，返回 403 错误

### 6.2 客户端保护（页面层）

后台管理页面（`/admin` 及子路由）在组件内执行以下检查：

1. 使用 `useAuth()` 获取用户状态
2. 若 `!loading && !user`，重定向到 `/login`
3. 若 `!loading && user && user.role !== 'admin'`，重定向到 `/chat`

此逻辑与现有 `/kb` 页面的保护方式一致（参见 `app/kb/page.tsx` 第 65-76 行）。

### 6.3 入口可见性控制

聊天页面顶部导航栏的"后台管理"链接仅在 `user.role === 'admin'` 时渲染，与现有"知识库"链接的处理方式一致。

---

## 7. 交互细节

### 7.1 聊天页面入口变更

在聊天页面顶部导航栏的 admin 区域（`app/chat/page.tsx` 第 288-296 行），在现有"知识库"链接旁边新增"后台管理"链接：

```
[知识库] [后台管理]  [头像] 用户名 [退出]
```

- "知识库"链接保持不变（`/kb`）
- 新增"后台管理"链接（`/admin`），样式与"知识库"链接一致

### 7.2 加载状态

- 页面初始加载时显示加载占位（与聊天页面一致的 loading 样式）
- API 请求时表格区域显示骨架屏或 loading 指示器
- 角色修改时对应行的下拉选择器显示为 disabled 状态

### 7.3 空状态

- 用户列表为空时显示"暂无用户数据"
- 文档列表为空时显示"暂无知识库文档"
- 搜索无结果时显示"未找到匹配的用户"

### 7.4 错误处理

- API 请求失败时在页面顶部显示错误提示（红色背景的 toast 消息，3 秒后自动消失）
- 角色修改失败时恢复下拉选择器到修改前的值，并显示错误提示

### 7.5 响应式设计

- 桌面端（`lg` 以上）：左侧导航栏常驻显示
- 移动端（`lg` 以下）：左侧导航栏默认隐藏，通过顶部汉堡菜单按钮展开，点击遮罩层关闭
- 表格在小屏幕上支持横向滚动（`overflow-x-auto`）

### 7.6 主题样式

使用项目已有的 CSS 变量和 Tailwind 主题令牌，保持风格统一：

- 背景色：`bg-background`
- 表面色：`bg-surface`
- 边框色：`border-edge`
- 主题色：`bg-accent`、`text-accent`
- 文字色：`text-foreground`、`text-dim`、`text-faint`
- 提升面：`bg-elevated`
- 圆角：`rounded-xl`（卡片）、`rounded-lg`（按钮、输入框）
- 输入框聚焦：`input-glow` 类
- 滚动条：`chat-scroll` 类
- 动画：`anim-card` 类（卡片入场动画）

---

## 8. 涉及文件清单

### 8.1 新建文件

| 文件路径 | 说明 |
|----------|------|
| `app/admin/layout.tsx` | 后台管理布局组件（顶部导航 + 左侧导航 + 内容区，含 admin 权限校验） |
| `app/admin/page.tsx` | 用户管理页面（用户列表、搜索、角色管理） |
| `app/admin/documents/page.tsx` | 知识库文档管理页面（全量文档列表、状态查看） |
| `app/api/admin/users/route.ts` | GET - 获取用户列表（支持搜索） |
| `app/api/admin/users/[userId]/route.ts` | PATCH - 修改用户角色 |
| `app/api/admin/documents/route.ts` | GET - 获取所有知识库文档 |

### 8.2 修改文件

| 文件路径 | 修改内容 |
|----------|----------|
| `app/chat/page.tsx` | 在 admin 区域新增"后台管理"链接（`/admin`），与现有"知识库"链接并列 |

---

## 9. 验收标准

### 9.1 功能验收

- [ ] admin 用户在聊天页面顶部导航栏可见"后台管理"链接，普通用户不可见
- [ ] 点击"后台管理"链接跳转到 `/admin` 页面
- [ ] 后台管理页面采用左侧导航 + 内容区布局，导航项正确高亮
- [ ] 用户管理页面正确展示所有用户的列表（用户名、邮箱、角色、注册时间）
- [ ] 用户搜索功能正常工作（按用户名或邮箱模糊搜索）
- [ ] 角色修改功能正常工作（下拉切换后立即更新）
- [ ] admin 不能修改自己的角色
- [ ] 知识库文档页面正确展示所有文档（含上传者用户名）
- [ ] 文档状态标签颜色正确（就绪/处理中/错误）
- [ ] 统计卡片数据准确

### 9.2 权限验收

- [ ] 未登录用户访问 `/admin` 重定向到 `/login`
- [ ] 普通用户（role=user）访问 `/admin` 重定向到 `/chat`
- [ ] 普通用户调用 `/api/admin/*` 接口返回 403
- [ ] 未登录用户调用 `/api/admin/*` 接口返回 401

### 9.3 样式验收

- [ ] 后台管理页面使用项目统一的紫靛色主题样式
- [ ] 亮色模式和暗色模式下均正常显示
- [ ] 响应式布局在移动端和桌面端均正常工作
- [ ] 左侧导航栏在移动端可收起/展开

### 9.4 交互验收

- [ ] 页面初始加载有 loading 状态
- [ ] 搜索有 300ms 防抖
- [ ] 角色修改时有 loading 状态，失败时正确回滚
- [ ] 空状态和错误状态正确显示
